services:
  nginx:
    build: ./nginx
    image: test-nginx
    depends_on:
      - frontend
      - backend
    ports: 
      - 80:80
      - 443:443
    container_name: test-nginx
    volumes:
      - "/etc/letsencrypt:/etc/letsencrypt"
    networks:
      - test-network

  frontend:
    build: ./frontend
    image: test-frontend
    container_name: test-frontend
    networks:
      - test-network


  backend:
    build: ./backend
    image: test-backend
    container_name: test-backend
    depends_on:
      mysqldb:
        condition: service_healthy
    networks:
      - test-network

  mysqldb:
    image: mysql:8.0.36
    environment:
      MYSQL_DATABASE: test
      MYSQL_USER: SMY
      MYSQL_PASSWORD: 1049139
      MYSQL_ROOT_PASSWORD: root
    container_name: test-mysqldb
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost", '-u', 'root', '-p$$MYSQL_ROOT_PASSWORD']
      timeout: 20s
      retries: 10
    volumes:
      - mysqldb-backup:/backup
        # - ./test_dump.sql:/test_dump.sql
    networks:
      - test-network





volumes:
  mysqldb-backup: {}
  nginx-volume: {}

networks:
  test-network: {}
